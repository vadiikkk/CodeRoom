worker_processes  auto;

error_log  /dev/stderr info;

env CODEROOM_JWT_SECRET;

events {
  worker_connections  1024;
}

http {
  include       mime.types;
  default_type  application/octet-stream;

  log_format main '$remote_addr - $remote_user [$time_local] '
                  '"$request" $status $body_bytes_sent '
                  '"$http_referer" "$http_user_agent" '
                  'rt=$request_time rid=$req_id';
  access_log /dev/stdout main;

  sendfile        on;
  keepalive_timeout  65;

  # ---- Rate limits (MVP defaults) ----
  limit_req_zone $binary_remote_addr zone=api_rps:10m rate=20r/s;
  limit_conn_zone $binary_remote_addr zone=api_conn:10m;

  upstream identity_service {
    server identity-service:8080;
    keepalive 32;
  }

  upstream course_service {
    server course-service:8080;
    keepalive 32;
  }

  server {
    listen 8080;

    client_max_body_size 10m;

    set_by_lua_block $req_id {
      local rid = ngx.var.http_x_request_id
      if rid and rid ~= "" then
        return rid
      end

      local random = require("resty.random")
      local str = require("resty.string")
      local bytes = random.bytes(16, true)
      return str.to_hex(bytes)
    }

    proxy_set_header X-Request-Id $req_id;
    add_header X-Request-Id $req_id always;

    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type,X-Request-Id" always;
    add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
    add_header Access-Control-Max-Age "86400" always;

    if ($request_method = OPTIONS) {
      return 204;
    }

    location = /health {
      default_type text/plain;
      return 200 "ok\n";
    }

    # ---- Unified Swagger UI config (aggregated) ----
    location = /v3/api-docs/swagger-config {
      default_type application/json;
      return 200 '{
        "urls": [
          { "url": "/v3/api-docs", "name": "identity-service" },
          { "url": "/course/v3/api-docs", "name": "course-service" }
        ],
        "urls.primaryName": "identity-service"
      }';
    }

    # ---- Identity-service routes ----
    location ^~ /api/v1/auth/ {
      limit_req zone=api_rps burst=40 nodelay;
      limit_conn api_conn 20;

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://identity_service;
    }

    location ^~ /api/v1/me {
      limit_req zone=api_rps burst=40 nodelay;
      limit_conn api_conn 20;

      access_by_lua_file /etc/nginx/lua/jwt_auth.lua;

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://identity_service;
    }

    location ^~ /api/v1/admin/ {
      limit_req zone=api_rps burst=40 nodelay;
      limit_conn api_conn 20;

      access_by_lua_file /etc/nginx/lua/jwt_auth.lua;

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://identity_service;
    }

    # ---- Course-service routes ----
    location ^~ /api/v1/courses/ {
      limit_req zone=api_rps burst=40 nodelay;
      limit_conn api_conn 20;

      access_by_lua_file /etc/nginx/lua/jwt_auth.lua;

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://course_service;
    }

    location = /api/v1/courses {
      limit_req zone=api_rps burst=40 nodelay;
      limit_conn api_conn 20;

      access_by_lua_file /etc/nginx/lua/jwt_auth.lua;

      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://course_service;
    }

    # Swagger/OpenAPI for course-service (proxied under /course/*)
    location ^~ /course/swagger-ui/ {
      return 302 /swagger-ui/index.html;
    }
    location = /course/v3/api-docs {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;

      proxy_pass http://course_service/v3/api-docs;
    }
    location ^~ /course/v3/api-docs/ {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;

      proxy_pass http://course_service/v3/api-docs/;
    }

    location ^~ /swagger-ui/ {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;

      proxy_pass http://identity_service;
    }
    location = /v3/api-docs {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;

      proxy_pass http://identity_service;
    }
    location ^~ /v3/api-docs/ {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;

      proxy_pass http://identity_service;
    }

    location / {
      default_type application/json;
      return 404 '{"error":"not_found"}';
    }
  }
}
